# Exploración de Datos {#data_explorer}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
require(knitr)
require(kableExtra)
library(readxl)
library(sf)
library(dplyr)
library(purrr)

# visualización
library(mapview)
library(ggplot2)
library(viridis)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(ggplot2)
theme_set(theme_bw())
nhead = 5
fsize = 10
```

Las bases de datos recibidas de Probreza Energética (27-07-2022), corresponden a 3 carpetas, las cuales en el presente capítulo se procederá un análisis descriptivo general.

![Estructura de carpeta de Bases de Datos](images/bbdd_folders.png)

## BBDD mapa vulneravilidad

### Descripción de Variables

**Nombre Archivo**: "*Detalle de campos.xlsx*"

```{r echo=FALSE}

campos <- read_excel("data/excel/Detalle de campos.xlsx")

kable_styling(
  kable(campos, digits = 3, row.names = FALSE, align = "c",
        caption = NULL),
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = TRUE,  font_size = 11) 
```

### Analisis Bases Espaciales

```{r lectura_shp}
# lectura
names_shps <- list.files(path = "data/shapes/", pattern = ".shp$") %>% 
  gsub(".shp", "", x = .)
files_shps <-  list.files(path = "data/shapes", pattern = ".shp$",
                          full.names = T) %>% 
  map(st_read, quiet = T)

names(files_shps) <-  names_shps

```

Dentro de la carpeta llamada `BBDD mapa vulneravilidad` existen 4 archivos en formato shapefiles, con los siguientes nombres:

-   `r names_shps[1]`
-   `r names_shps[2]`
-   `r names_shps[3]`
-   `r names_shps[4]`

```{r}
region = "COQUIMBO"
var1 <- "EST_PROY_E"
var2 <- "EMPRESA_1"
var3 <- "TIPO_SUM_S"
var4 <- "NOM_FV_IND"
```

Para visualizar los objetos esjetos espaciales se procedió a elegir una región de `r region`, continiación se procede a hacer exploración de las tablas de contenidos y visualización espacial por cada uno de ellos:

<!-- base -->

```{r}
indice = 1
```

#### `r names(files_shps)[indice]`

```{r frec-1}
files_shps[[indice]] %>% 
  st_drop_geometry() %>% 
  plot_frq(!!!var2, title = paste0("Frecuencia de ",  var2))
```



**Tabla de Variables**: Región de "`r region`"

```{r}
data_reg <- files_shps[[indice]] %>% filter(NOM_REGION == region)

```

```{r}
kable_styling(
  kable(data_reg %>% st_drop_geometry() %>% head(nhead), 
        digits = 3, row.names = FALSE, align = "c",
        caption = NULL),
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = FALSE,  font_size = fsize)%>%
  scroll_box(width = "100%")
```

**Visualización Espacial**: Región de "`r region`"

```{r}

# Visualización ggplot y sf
# ggplot() +
#   geom_sf(data = data_reg, aes(color = EMPRESA_1), alpha= 0.8)+
#   scale_color_viridis_d(na.value = "gray50")+
#   ggtitle(paste0("Base: ", names(files_shps)[1], "\nRegión de: ", region)) +
#   theme_bw() +
#   theme(panel.grid.major = element_line(colour = "gray80"),
#         panel.grid.minor = element_line(colour = "gray80"))

 data_reg %>% mapview::mapview(zcol =var1, cex = 3)
```

<!-- base -->

```{r}
indice = 2

```

#### `r names(files_shps)[indice]`

```{r frec-2}
files_shps[[indice]] %>% 
  st_drop_geometry() %>% 
  plot_frq(!!!var2, title = paste0("Frecuencia de ",  var2))
```




**Tabla de Variables**:

```{r}
data_reg <- files_shps[[indice]] %>% filter(NOM_REGION == region)

```

```{r}
kable_styling(
  kable(data_reg %>% st_drop_geometry() %>% head(nhead), 
        digits = 3, row.names = FALSE, align = "c",
        caption =NULL),
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = FALSE,  font_size = fsize) %>%
  scroll_box(width = "100%")
```

**Visualización Espacial**: Región de "`r region`"

```{r}

# Visualización ggplot y sf
# ggplot() +
#   geom_sf(data = data_reg, aes(color = EMPRESA_1), alpha= 0.8)+
#   scale_color_viridis_d(na.value = "gray50")+
#   ggtitle(paste0("Base: ", names(files_shps)[1], "\nRegión de: ", region)) +
#   theme_bw() +
#   theme(panel.grid.major = element_line(colour = "gray80"),
#         panel.grid.minor = element_line(colour = "gray80"))

 data_reg %>% mapview::mapview(zcol =var2, cex = 3)
```

<!-- base -->

```{r}
indice = 3
```

#### `r names(files_shps)[indice]`

```{r frec-3}
files_shps[[indice]] %>% 
  st_drop_geometry() %>% 
  plot_frq(!!!var3, title = paste0("Frecuencia de ",  var3))
```



**Tabla de Variables**:

```{r}
data_reg <- files_shps[[indice]] %>% filter(NOM_REGION == region)

```

```{r}
kable_styling(
  kable(data_reg %>% st_drop_geometry() %>% head(nhead), 
        digits = 3, row.names = FALSE, align = "c",
        caption = NULL),
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = TRUE,  font_size = fsize) %>%
  scroll_box(width = "100%")
```

**Visualización Espacial**: Región de "`r region`"

```{r}

# Visualización ggplot y sf
# ggplot() +
#   geom_sf(data = data_reg, aes(color = EMPRESA_1), alpha= 0.8)+
#   scale_color_viridis_d(na.value = "gray50")+
#   ggtitle(paste0("Base: ", names(files_shps)[1], "\nRegión de: ", region)) +
#   theme_bw() +
#   theme(panel.grid.major = element_line(colour = "gray80"),
#         panel.grid.minor = element_line(colour = "gray80"))

 data_reg %>% mapview::mapview(zcol =var3, cex = 3)
```

<!-- base -->

```{r}
indice = 4
```

#### `r names(files_shps)[indice]`

```{r frec-4}
files_shps[[indice]] %>% 
  st_drop_geometry() %>% 
  plot_frq(!!!var4, title = paste0("Frecuencia de ",  var4))
```

**Tabla de Variables**:

```{r}
data_reg <- files_shps[[indice]] %>% filter(NOM_REGION == region)

```

```{r}
kable_styling(
  kable(data_reg %>% st_drop_geometry() %>% head(nhead), 
        digits = 3, row.names = FALSE, align = "c",
        caption = NULL),
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center", full_width = TRUE,  font_size = fsize) %>%
  scroll_box(width = "100%")
```

**Visualización Espacial**: Región de "`r region`"

```{r}

# Visualización ggplot y sf
# ggplot() +
#   geom_sf(data = data_reg, aes(color = EMPRESA_1), alpha= 0.8)+
#   scale_color_viridis_d(na.value = "gray50")+
#   ggtitle(paste0("Base: ", names(files_shps)[1], "\nRegión de: ", region)) +
#   theme_bw() +
#   theme(panel.grid.major = element_line(colour = "gray80"),
#         panel.grid.minor = element_line(colour = "gray80"))

 data_reg %>% mapview::mapview(zcol =var4, cex = 3)
```
